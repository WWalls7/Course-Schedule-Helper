{"ast":null,"code":"/**\r\n * DevExtreme (ui/scheduler/ui.scheduler.appointment_model.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _config = require(\"../../core/config\");\n\nvar _config2 = _interopRequireDefault(_config);\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _iterator2 = _interopRequireDefault(_iterator);\n\nvar _date_serialization = require(\"../../core/utils/date_serialization\");\n\nvar _date_serialization2 = _interopRequireDefault(_date_serialization);\n\nvar _utils = require(\"./utils.recurrence\");\n\nvar _utils2 = _interopRequireDefault(_utils);\n\nvar _date = require(\"../../core/utils/date\");\n\nvar _date2 = _interopRequireDefault(_date);\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _type2 = _interopRequireDefault(_type);\n\nvar _array = require(\"../../core/utils/array\");\n\nvar _array2 = _interopRequireDefault(_array);\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _query = require(\"../../data/query\");\n\nvar _query2 = _interopRequireDefault(_query);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n\n    if (\"value\" in descriptor) {\n      descriptor.writable = true;\n    }\n\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) {\n    _defineProperties(Constructor.prototype, protoProps);\n  }\n\n  if (staticProps) {\n    _defineProperties(Constructor, staticProps);\n  }\n\n  return Constructor;\n}\n\nvar toMs = _date2.default.dateToMilliseconds;\nvar DATE_FILTER_POSITION = 0;\nvar USER_FILTER_POSITION = 1;\n\nvar FilterMaker = function () {\n  function FilterMaker(dataAccessors) {\n    _classCallCheck(this, FilterMaker);\n\n    this._filterRegistry = null;\n    this._dataAccessors = dataAccessors;\n  }\n\n  _createClass(FilterMaker, [{\n    key: \"isRegistered\",\n    value: function () {\n      return !!this._filterRegistry;\n    }\n  }, {\n    key: \"clearRegistry\",\n    value: function () {\n      delete this._filterRegistry;\n    }\n  }, {\n    key: \"make\",\n    value: function (type, args) {\n      if (!this._filterRegistry) {\n        this._filterRegistry = {};\n      }\n\n      this._make(type).apply(this, args);\n    }\n  }, {\n    key: \"_make\",\n    value: function (type) {\n      var _this = this;\n\n      switch (type) {\n        case \"date\":\n          return function (min, max, useAccessors) {\n            var startDate = useAccessors ? _this._dataAccessors.getter.startDate : _this._dataAccessors.expr.startDateExpr;\n            var endDate = useAccessors ? _this._dataAccessors.getter.endDate : _this._dataAccessors.expr.endDateExpr;\n            var recurrenceRule = _this._dataAccessors.expr.recurrenceRuleExpr;\n            _this._filterRegistry.date = [[[endDate, \">\", min], [startDate, \"<\", max]], \"or\", [recurrenceRule, \"startswith\", \"freq\"], \"or\", [[endDate, min], [startDate, min]]];\n\n            if (!recurrenceRule) {\n              _this._filterRegistry.date.splice(1, 2);\n            }\n          };\n\n        case \"user\":\n          return function (userFilter) {\n            _this._filterRegistry.user = userFilter;\n          };\n      }\n    }\n  }, {\n    key: \"combine\",\n    value: function () {\n      var filter = [];\n      this._filterRegistry.date && filter.push(this._filterRegistry.date);\n      this._filterRegistry.user && filter.push(this._filterRegistry.user);\n      return filter;\n    }\n  }, {\n    key: \"dateFilter\",\n    value: function () {\n      return this._filterRegistry.date;\n    }\n  }]);\n\n  return FilterMaker;\n}();\n\nvar compareDateWithStartDayHour = function (startDate, endDate, startDayHour, allDay, severalDays) {\n  var startTime = _date2.default.dateTimeFromDecimal(startDayHour);\n\n  var result = startDate.getHours() >= startTime.hours && startDate.getMinutes() >= startTime.minutes || endDate.getHours() === startTime.hours && endDate.getMinutes() > startTime.minutes || endDate.getHours() > startTime.hours || severalDays || allDay;\n  return result;\n};\n\nvar compareDateWithEndDayHour = function (startDate, endDate, startDayHour, endDayHour, allDay, severalDays, max, min) {\n  var hiddenInterval = (24 - endDayHour + startDayHour) * toMs(\"hour\");\n  var apptDuration = endDate.getTime() - startDate.getTime();\n  var delta = (hiddenInterval - apptDuration) / toMs(\"hour\");\n  var apptStartHour = startDate.getHours();\n  var apptStartMinutes = startDate.getMinutes();\n  var result;\n\n  var endTime = _date2.default.dateTimeFromDecimal(endDayHour);\n\n  var startTime = _date2.default.dateTimeFromDecimal(startDayHour);\n\n  result = apptStartHour < endTime.hours || apptStartHour === endTime.hours && apptStartMinutes < endTime.minutes || allDay && startDate <= max || severalDays && startDate < max && endDate > min && (apptStartHour < endTime.hours || 60 * endDate.getHours() + endDate.getMinutes() > 60 * startTime.hours);\n\n  if (apptDuration < hiddenInterval) {\n    if (apptStartHour > endTime.hours && apptStartMinutes > endTime.minutes && delta <= apptStartHour - endDayHour) {\n      result = false;\n    }\n  }\n\n  return result;\n};\n\nvar AppointmentModel = function () {\n  function AppointmentModel(dataSource, dataAccessors, baseAppointmentDuration) {\n    _classCallCheck(this, AppointmentModel);\n\n    this.setDataAccessors(dataAccessors);\n    this.setDataSource(dataSource);\n    this._updatedAppointmentKeys = [];\n    this._filterMaker = new FilterMaker(dataAccessors);\n    this._baseAppointmentDuration = baseAppointmentDuration;\n  }\n\n  _createClass(AppointmentModel, [{\n    key: \"_createFilter\",\n    value: function (min, max, remoteFiltering, dateSerializationFormat) {\n      this._filterMaker.make(\"date\", [min, max]);\n\n      var userFilterPosition = this._excessFiltering() ? this._dataSource.filter()[USER_FILTER_POSITION] : this._dataSource.filter();\n\n      this._filterMaker.make(\"user\", [userFilterPosition]);\n\n      if (remoteFiltering) {\n        this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat));\n      }\n    }\n  }, {\n    key: \"_excessFiltering\",\n    value: function () {\n      var dateFilter = this._filterMaker.dateFilter();\n\n      var dataSourceFilter = this._dataSource.filter();\n\n      return dataSourceFilter && ((0, _common.equalByValue)(dataSourceFilter, dateFilter) || dataSourceFilter.length && (0, _common.equalByValue)(dataSourceFilter[DATE_FILTER_POSITION], dateFilter));\n    }\n  }, {\n    key: \"_combineFilter\",\n    value: function () {\n      return this._filterMaker.combine();\n    }\n  }, {\n    key: \"_getStoreKey\",\n    value: function (target) {\n      var store = this._dataSource.store();\n\n      return store.keyOf(target);\n    }\n  }, {\n    key: \"_filterAppointmentByResources\",\n    value: function (appointment, resources) {\n      var _this2 = this;\n\n      var result = false;\n\n      var checkAppointmentResourceValues = function () {\n        var resourceGetter = _this2._dataAccessors.getter.resources[resourceName];\n        var resource;\n\n        if (_type2.default.isFunction(resourceGetter)) {\n          resource = resourceGetter(appointment);\n        }\n\n        var appointmentResourceValues = _array2.default.wrapToArray(resource);\n\n        var resourceData = _iterator2.default.map(resources[i].items, function (item) {\n          return item.id;\n        });\n\n        for (var j = 0, itemDataCount = appointmentResourceValues.length; j < itemDataCount; j++) {\n          if ((0, _array.inArray)(appointmentResourceValues[j], resourceData) > -1) {\n            return true;\n          }\n        }\n\n        return false;\n      };\n\n      for (var i = 0, len = resources.length; i < len; i++) {\n        var resourceName = resources[i].name;\n        result = checkAppointmentResourceValues.call(this);\n\n        if (!result) {\n          return false;\n        }\n      }\n\n      return result;\n    }\n  }, {\n    key: \"_filterAppointmentByRRule\",\n    value: function (appointment, min, max, startDayHour, endDayHour, firstDayOfWeek) {\n      var recurrenceRule = appointment.recurrenceRule;\n      var recurrenceException = appointment.recurrenceException;\n      var allDay = appointment.allDay;\n      var result = true;\n      var appointmentStartDate = appointment.startDate;\n      var appointmentEndDate = appointment.endDate;\n\n      if (allDay || this._appointmentPartInInterval(appointmentStartDate, appointmentEndDate, startDayHour, endDayHour)) {\n        var trimmedDates = this._trimDates(min, max);\n\n        min = trimmedDates.min;\n        max = new Date(trimmedDates.max.getTime() - toMs(\"minute\"));\n      }\n\n      if (recurrenceRule && !_utils2.default.getRecurrenceRule(recurrenceRule).isValid) {\n        result = appointmentEndDate > min && appointmentStartDate <= max;\n      }\n\n      if (result && _utils2.default.getRecurrenceRule(recurrenceRule).isValid) {\n        result = _utils2.default.dateInRecurrenceRange({\n          rule: recurrenceRule,\n          exception: recurrenceException,\n          start: appointmentStartDate,\n          end: appointmentEndDate,\n          min: min,\n          max: max,\n          firstDayOfWeek: firstDayOfWeek\n        });\n      }\n\n      return result;\n    }\n  }, {\n    key: \"_appointmentPartInInterval\",\n    value: function (startDate, endDate, startDayHour, endDayHour) {\n      var apptStartDayHour = startDate.getHours();\n      var apptEndDayHour = endDate.getHours();\n      return apptStartDayHour <= startDayHour && apptEndDayHour <= endDayHour && apptEndDayHour >= startDayHour || apptEndDayHour >= endDayHour && apptStartDayHour <= endDayHour && apptStartDayHour >= startDayHour;\n    }\n  }, {\n    key: \"_createCombinedFilter\",\n    value: function (filterOptions, timeZoneProcessor) {\n      var dataAccessors = this._dataAccessors;\n      var startDayHour = filterOptions.startDayHour;\n      var endDayHour = filterOptions.endDayHour;\n      var min = new Date(filterOptions.min);\n      var max = new Date(filterOptions.max);\n      var resources = filterOptions.resources;\n      var firstDayOfWeek = filterOptions.firstDayOfWeek;\n      var getRecurrenceException = filterOptions.recurrenceException;\n      var that = this;\n      return [[function (appointment) {\n        var result = true;\n        var startDate = new Date(dataAccessors.getter.startDate(appointment));\n        var endDate = new Date(dataAccessors.getter.endDate(appointment));\n        var appointmentTakesAllDay = that.appointmentTakesAllDay(appointment, startDayHour, endDayHour);\n        var appointmentTakesSeveralDays = that.appointmentTakesSeveralDays(appointment);\n        var isAllDay = dataAccessors.getter.allDay(appointment);\n        var appointmentIsLong = appointmentTakesSeveralDays || appointmentTakesAllDay;\n\n        var useRecurrence = _type2.default.isDefined(dataAccessors.getter.recurrenceRule);\n\n        var recurrenceRule;\n\n        if (useRecurrence) {\n          recurrenceRule = dataAccessors.getter.recurrenceRule(appointment);\n        }\n\n        if (resources && resources.length) {\n          result = that._filterAppointmentByResources(appointment, resources);\n        }\n\n        if (appointmentTakesAllDay && false === filterOptions.allDay) {\n          result = false;\n        }\n\n        var startDateTimeZone = dataAccessors.getter.startDateTimeZone(appointment);\n        var endDateTimeZone = dataAccessors.getter.endDateTimeZone(appointment);\n        var comparableStartDate = timeZoneProcessor(startDate, startDateTimeZone);\n        var comparableEndDate = timeZoneProcessor(endDate, endDateTimeZone);\n\n        if (result && useRecurrence) {\n          var recurrenceException = getRecurrenceException ? getRecurrenceException(appointment) : dataAccessors.getter.recurrenceException(appointment);\n          result = that._filterAppointmentByRRule({\n            startDate: comparableStartDate,\n            endDate: comparableEndDate,\n            recurrenceRule: recurrenceRule,\n            recurrenceException: recurrenceException,\n            allDay: appointmentTakesAllDay\n          }, min, max, startDayHour, endDayHour, firstDayOfWeek);\n        }\n\n        if (result && comparableEndDate < min && appointmentIsLong && !isAllDay && (!useRecurrence || useRecurrence && !recurrenceRule)) {\n          result = false;\n        }\n\n        if (result && void 0 !== startDayHour) {\n          result = compareDateWithStartDayHour(comparableStartDate, comparableEndDate, startDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays);\n        }\n\n        if (result && void 0 !== endDayHour) {\n          result = compareDateWithEndDayHour(comparableStartDate, comparableEndDate, startDayHour, endDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays, max, min);\n        }\n\n        if (result && useRecurrence && !recurrenceRule) {\n          if (comparableEndDate < min && !isAllDay) {\n            result = false;\n          }\n        }\n\n        return result;\n      }]];\n    }\n  }, {\n    key: \"setDataSource\",\n    value: function (dataSource) {\n      this._dataSource = dataSource;\n      this.cleanModelState();\n\n      this._initStoreChangeHandlers();\n\n      this._filterMaker && this._filterMaker.clearRegistry();\n    }\n  }, {\n    key: \"_initStoreChangeHandlers\",\n    value: function () {\n      var _this3 = this;\n\n      this._dataSource && this._dataSource.store().on(\"updating\", function (newItem) {\n        _this3._updatedAppointment = newItem;\n      }.bind(this));\n      this._dataSource && this._dataSource.store().on(\"push\", function (items) {\n        items.forEach(function (item) {\n          _this3._updatedAppointmentKeys.push({\n            key: _this3._dataSource.store().key(),\n            value: item.key\n          });\n        }.bind(_this3));\n      }.bind(this));\n    }\n  }, {\n    key: \"getUpdatedAppointment\",\n    value: function () {\n      return this._updatedAppointment;\n    }\n  }, {\n    key: \"getUpdatedAppointmentKeys\",\n    value: function () {\n      return this._updatedAppointmentKeys;\n    }\n  }, {\n    key: \"cleanModelState\",\n    value: function () {\n      this._updatedAppointment = null;\n      this._updatedAppointmentKeys = [];\n    }\n  }, {\n    key: \"setDataAccessors\",\n    value: function (dataAccessors) {\n      this._dataAccessors = dataAccessors;\n      this._filterMaker = new FilterMaker(dataAccessors);\n    }\n  }, {\n    key: \"filterByDate\",\n    value: function (min, max, remoteFiltering, dateSerializationFormat) {\n      if (!this._dataSource) {\n        return;\n      }\n\n      var trimmedDates = this._trimDates(min, max);\n\n      if (!this._filterMaker.isRegistered()) {\n        this._createFilter(trimmedDates.min, trimmedDates.max, remoteFiltering, dateSerializationFormat);\n      } else {\n        this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max]);\n\n        if (this._dataSource.filter() && this._dataSource.filter().length > 1) {\n          var userFilter = this._serializeRemoteFilter([this._dataSource.filter()[1]], dateSerializationFormat);\n\n          this._filterMaker.make(\"user\", userFilter);\n        }\n\n        if (remoteFiltering) {\n          this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat));\n        }\n      }\n    }\n  }, {\n    key: \"_combineRemoteFilter\",\n    value: function (dateSerializationFormat) {\n      var combinedFilter = this._filterMaker.combine();\n\n      return this._serializeRemoteFilter(combinedFilter, dateSerializationFormat);\n    }\n  }, {\n    key: \"_serializeRemoteFilter\",\n    value: function (filter, dateSerializationFormat) {\n      if (!Array.isArray(filter)) {\n        return filter;\n      }\n\n      filter = (0, _extend.extend)([], filter);\n      var startDate = this._dataAccessors.expr.startDateExpr;\n      var endDate = this._dataAccessors.expr.endDateExpr;\n\n      if (_type2.default.isString(filter[0])) {\n        if ((0, _config2.default)().forceIsoDateParsing && filter.length > 1) {\n          if (filter[0] === startDate || filter[0] === endDate) {\n            filter[filter.length - 1] = _date_serialization2.default.serializeDate(new Date(filter[filter.length - 1]), dateSerializationFormat);\n          }\n        }\n      }\n\n      for (var i = 0; i < filter.length; i++) {\n        filter[i] = this._serializeRemoteFilter(filter[i], dateSerializationFormat);\n      }\n\n      return filter;\n    }\n  }, {\n    key: \"filterLoadedAppointments\",\n    value: function (filterOptions, timeZoneProcessor) {\n      if (!_type2.default.isFunction(timeZoneProcessor)) {\n        timeZoneProcessor = function (date) {\n          return date;\n        };\n      }\n\n      var combinedFilter = this._createCombinedFilter(filterOptions, timeZoneProcessor);\n\n      if (this._filterMaker.isRegistered()) {\n        var trimmedDates = this._trimDates(filterOptions.min, filterOptions.max);\n\n        this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max, true]);\n\n        var dateFilter = this.customizeDateFilter(this._filterMaker.combine(), timeZoneProcessor);\n        combinedFilter.push([dateFilter]);\n      }\n\n      return (0, _query2.default)(this._dataSource.items()).filter(combinedFilter).toArray();\n    }\n  }, {\n    key: \"_trimDates\",\n    value: function (min, max) {\n      var minCopy = _date2.default.trimTime(new Date(min));\n\n      var maxCopy = _date2.default.trimTime(new Date(max));\n\n      maxCopy.setDate(maxCopy.getDate() + 1);\n      return {\n        min: minCopy,\n        max: maxCopy\n      };\n    }\n  }, {\n    key: \"hasAllDayAppointments\",\n    value: function (items, startDayHour, endDayHour) {\n      if (!items) {\n        return false;\n      }\n\n      var that = this;\n      var result = false;\n\n      _iterator2.default.each(items, function (index, item) {\n        if (that.appointmentTakesAllDay(item, startDayHour, endDayHour)) {\n          result = true;\n          return false;\n        }\n      });\n\n      return result;\n    }\n  }, {\n    key: \"appointmentTakesAllDay\",\n    value: function (appointment, startDayHour, endDayHour) {\n      var dataAccessors = this._dataAccessors;\n      var startDate = dataAccessors.getter.startDate(appointment);\n      var endDate = dataAccessors.getter.endDate(appointment);\n      var allDay = dataAccessors.getter.allDay(appointment);\n      return allDay || this._appointmentHasAllDayDuration(startDate, endDate, startDayHour, endDayHour);\n    }\n  }, {\n    key: \"_appointmentHasAllDayDuration\",\n    value: function (startDate, endDate, startDayHour, endDayHour) {\n      startDate = new Date(startDate);\n      endDate = new Date(endDate);\n      var dayDuration = 24;\n\n      var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\n\n      return appointmentDurationInHours >= dayDuration || this._appointmentHasShortDayDuration(startDate, endDate, startDayHour, endDayHour);\n    }\n  }, {\n    key: \"_appointmentHasShortDayDuration\",\n    value: function (startDate, endDate, startDayHour, endDayHour) {\n      var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\n\n      var shortDayDurationInHours = endDayHour - startDayHour;\n      return appointmentDurationInHours >= shortDayDurationInHours && startDate.getHours() === startDayHour && endDate.getHours() === endDayHour;\n    }\n  }, {\n    key: \"_getAppointmentDurationInHours\",\n    value: function (startDate, endDate) {\n      return (endDate.getTime() - startDate.getTime()) / toMs(\"hour\");\n    }\n  }, {\n    key: \"appointmentTakesSeveralDays\",\n    value: function (appointment) {\n      var dataAccessors = this._dataAccessors;\n      var startDate = dataAccessors.getter.startDate(appointment);\n      var endDate = dataAccessors.getter.endDate(appointment);\n\n      var startDateCopy = _date2.default.trimTime(new Date(startDate));\n\n      var endDateCopy = _date2.default.trimTime(new Date(endDate));\n\n      return startDateCopy.getTime() !== endDateCopy.getTime();\n    }\n  }, {\n    key: \"customizeDateFilter\",\n    value: function (dateFilter, timeZoneProcessor) {\n      var _this4 = this;\n\n      var currentFilter = (0, _extend.extend)(true, [], dateFilter);\n      return function (appointment) {\n        var startDate = new Date(_this4._dataAccessors.getter.startDate(appointment));\n        var endDate = new Date(_this4._dataAccessors.getter.endDate(appointment));\n        endDate = _this4.fixWrongEndDate(appointment, startDate, endDate);\n        appointment = (0, _extend.extend)(true, {}, appointment);\n\n        var startDateTimeZone = _this4._dataAccessors.getter.startDateTimeZone(appointment);\n\n        var endDateTimeZone = _this4._dataAccessors.getter.endDateTimeZone(appointment);\n\n        var comparableStartDate = timeZoneProcessor(startDate, startDateTimeZone);\n        var comparableEndDate = timeZoneProcessor(endDate, endDateTimeZone);\n\n        _this4._dataAccessors.setter.startDate(appointment, comparableStartDate);\n\n        _this4._dataAccessors.setter.endDate(appointment, comparableEndDate);\n\n        return (0, _query2.default)([appointment]).filter(currentFilter).toArray().length > 0;\n      }.bind(this);\n    }\n  }, {\n    key: \"fixWrongEndDate\",\n    value: function (appointment, startDate, endDate) {\n      if (this._isEndDateWrong(appointment, startDate, endDate)) {\n        if (this._dataAccessors.getter.allDay(appointment)) {\n          endDate = _date2.default.setToDayEnd(new Date(startDate));\n        } else {\n          endDate = new Date(startDate.getTime() + this._baseAppointmentDuration * toMs(\"minute\"));\n        }\n\n        this._dataAccessors.setter.endDate(appointment, endDate);\n      }\n\n      return endDate;\n    }\n  }, {\n    key: \"_isEndDateWrong\",\n    value: function (appointment, startDate, endDate) {\n      return !endDate || isNaN(endDate.getTime()) || startDate.getTime() > endDate.getTime();\n    }\n  }, {\n    key: \"add\",\n    value: function (data, tz) {\n      var _this5 = this;\n\n      return this._dataSource.store().insert(data).done(function () {\n        _this5._dataSource.load();\n      }.bind(this));\n    }\n  }, {\n    key: \"update\",\n    value: function (target, data) {\n      var _this6 = this;\n\n      var key = this._getStoreKey(target);\n\n      var d = new _deferred.Deferred();\n\n      this._dataSource.store().update(key, data).done(function () {\n        _this6._dataSource.load().done(d.resolve).fail(d.reject);\n      }).fail(d.reject);\n\n      return d.promise();\n    }\n  }, {\n    key: \"remove\",\n    value: function (target) {\n      var _this7 = this;\n\n      var key = this._getStoreKey(target);\n\n      return this._dataSource.store().remove(key).done(function () {\n        _this7._dataSource.load();\n      }.bind(this));\n    }\n  }]);\n\n  return AppointmentModel;\n}();\n\nmodule.exports = AppointmentModel;","map":{"version":3,"sources":["C:/Users/Swizzle/Desktop/SE Project/Application/csh/node_modules/devextreme/ui/scheduler/ui.scheduler.appointment_model.js"],"names":["_config","require","_config2","_interopRequireDefault","_iterator","_iterator2","_date_serialization","_date_serialization2","_utils","_utils2","_date","_date2","_common","_type","_type2","_array","_array2","_extend","_query","_query2","_deferred","obj","__esModule","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_createClass","protoProps","staticProps","prototype","toMs","default","dateToMilliseconds","DATE_FILTER_POSITION","USER_FILTER_POSITION","FilterMaker","dataAccessors","_filterRegistry","_dataAccessors","value","type","args","_make","apply","_this","min","max","useAccessors","startDate","getter","expr","startDateExpr","endDate","endDateExpr","recurrenceRule","recurrenceRuleExpr","date","splice","userFilter","user","filter","push","compareDateWithStartDayHour","startDayHour","allDay","severalDays","startTime","dateTimeFromDecimal","result","getHours","hours","getMinutes","minutes","compareDateWithEndDayHour","endDayHour","hiddenInterval","apptDuration","getTime","delta","apptStartHour","apptStartMinutes","endTime","AppointmentModel","dataSource","baseAppointmentDuration","setDataAccessors","setDataSource","_updatedAppointmentKeys","_filterMaker","_baseAppointmentDuration","remoteFiltering","dateSerializationFormat","make","userFilterPosition","_excessFiltering","_dataSource","_combineRemoteFilter","dateFilter","dataSourceFilter","equalByValue","combine","store","keyOf","appointment","resources","_this2","checkAppointmentResourceValues","resourceGetter","resourceName","resource","isFunction","appointmentResourceValues","wrapToArray","resourceData","map","items","item","id","j","itemDataCount","inArray","len","name","call","firstDayOfWeek","recurrenceException","appointmentStartDate","appointmentEndDate","_appointmentPartInInterval","trimmedDates","_trimDates","Date","getRecurrenceRule","isValid","dateInRecurrenceRange","rule","exception","start","end","apptStartDayHour","apptEndDayHour","filterOptions","timeZoneProcessor","getRecurrenceException","that","appointmentTakesAllDay","appointmentTakesSeveralDays","isAllDay","appointmentIsLong","useRecurrence","isDefined","_filterAppointmentByResources","startDateTimeZone","endDateTimeZone","comparableStartDate","comparableEndDate","_filterAppointmentByRRule","cleanModelState","_initStoreChangeHandlers","clearRegistry","_this3","on","newItem","_updatedAppointment","bind","forEach","isRegistered","_createFilter","_serializeRemoteFilter","combinedFilter","Array","isArray","extend","isString","forceIsoDateParsing","serializeDate","_createCombinedFilter","customizeDateFilter","toArray","minCopy","trimTime","maxCopy","setDate","getDate","each","index","_appointmentHasAllDayDuration","dayDuration","appointmentDurationInHours","_getAppointmentDurationInHours","_appointmentHasShortDayDuration","shortDayDurationInHours","startDateCopy","endDateCopy","_this4","currentFilter","fixWrongEndDate","setter","_isEndDateWrong","setToDayEnd","isNaN","data","tz","_this5","insert","done","load","_this6","_getStoreKey","d","Deferred","update","resolve","fail","reject","promise","_this7","remove","module","exports"],"mappings":"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","sourcesContent":["/**\r\n * DevExtreme (ui/scheduler/ui.scheduler.appointment_model.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\r\n\"use strict\";\r\nvar _config = require(\"../../core/config\");\r\nvar _config2 = _interopRequireDefault(_config);\r\nvar _iterator = require(\"../../core/utils/iterator\");\r\nvar _iterator2 = _interopRequireDefault(_iterator);\r\nvar _date_serialization = require(\"../../core/utils/date_serialization\");\r\nvar _date_serialization2 = _interopRequireDefault(_date_serialization);\r\nvar _utils = require(\"./utils.recurrence\");\r\nvar _utils2 = _interopRequireDefault(_utils);\r\nvar _date = require(\"../../core/utils/date\");\r\nvar _date2 = _interopRequireDefault(_date);\r\nvar _common = require(\"../../core/utils/common\");\r\nvar _type = require(\"../../core/utils/type\");\r\nvar _type2 = _interopRequireDefault(_type);\r\nvar _array = require(\"../../core/utils/array\");\r\nvar _array2 = _interopRequireDefault(_array);\r\nvar _extend = require(\"../../core/utils/extend\");\r\nvar _query = require(\"../../data/query\");\r\nvar _query2 = _interopRequireDefault(_query);\r\nvar _deferred = require(\"../../core/utils/deferred\");\r\n\r\nfunction _interopRequireDefault(obj) {\r\n    return obj && obj.__esModule ? obj : {\r\n        \"default\": obj\r\n    }\r\n}\r\n\r\nfunction _classCallCheck(instance, Constructor) {\r\n    if (!(instance instanceof Constructor)) {\r\n        throw new TypeError(\"Cannot call a class as a function\")\r\n    }\r\n}\r\n\r\nfunction _defineProperties(target, props) {\r\n    for (var i = 0; i < props.length; i++) {\r\n        var descriptor = props[i];\r\n        descriptor.enumerable = descriptor.enumerable || false;\r\n        descriptor.configurable = true;\r\n        if (\"value\" in descriptor) {\r\n            descriptor.writable = true\r\n        }\r\n        Object.defineProperty(target, descriptor.key, descriptor)\r\n    }\r\n}\r\n\r\nfunction _createClass(Constructor, protoProps, staticProps) {\r\n    if (protoProps) {\r\n        _defineProperties(Constructor.prototype, protoProps)\r\n    }\r\n    if (staticProps) {\r\n        _defineProperties(Constructor, staticProps)\r\n    }\r\n    return Constructor\r\n}\r\nvar toMs = _date2.default.dateToMilliseconds;\r\nvar DATE_FILTER_POSITION = 0;\r\nvar USER_FILTER_POSITION = 1;\r\nvar FilterMaker = function() {\r\n    function FilterMaker(dataAccessors) {\r\n        _classCallCheck(this, FilterMaker);\r\n        this._filterRegistry = null;\r\n        this._dataAccessors = dataAccessors\r\n    }\r\n    _createClass(FilterMaker, [{\r\n        key: \"isRegistered\",\r\n        value: function() {\r\n            return !!this._filterRegistry\r\n        }\r\n    }, {\r\n        key: \"clearRegistry\",\r\n        value: function() {\r\n            delete this._filterRegistry\r\n        }\r\n    }, {\r\n        key: \"make\",\r\n        value: function(type, args) {\r\n            if (!this._filterRegistry) {\r\n                this._filterRegistry = {}\r\n            }\r\n            this._make(type).apply(this, args)\r\n        }\r\n    }, {\r\n        key: \"_make\",\r\n        value: function(type) {\r\n            var _this = this;\r\n            switch (type) {\r\n                case \"date\":\r\n                    return function(min, max, useAccessors) {\r\n                        var startDate = useAccessors ? _this._dataAccessors.getter.startDate : _this._dataAccessors.expr.startDateExpr;\r\n                        var endDate = useAccessors ? _this._dataAccessors.getter.endDate : _this._dataAccessors.expr.endDateExpr;\r\n                        var recurrenceRule = _this._dataAccessors.expr.recurrenceRuleExpr;\r\n                        _this._filterRegistry.date = [\r\n                            [\r\n                                [endDate, \">\", min],\r\n                                [startDate, \"<\", max]\r\n                            ], \"or\", [recurrenceRule, \"startswith\", \"freq\"], \"or\", [\r\n                                [endDate, min],\r\n                                [startDate, min]\r\n                            ]\r\n                        ];\r\n                        if (!recurrenceRule) {\r\n                            _this._filterRegistry.date.splice(1, 2)\r\n                        }\r\n                    };\r\n                case \"user\":\r\n                    return function(userFilter) {\r\n                        _this._filterRegistry.user = userFilter\r\n                    }\r\n            }\r\n        }\r\n    }, {\r\n        key: \"combine\",\r\n        value: function() {\r\n            var filter = [];\r\n            this._filterRegistry.date && filter.push(this._filterRegistry.date);\r\n            this._filterRegistry.user && filter.push(this._filterRegistry.user);\r\n            return filter\r\n        }\r\n    }, {\r\n        key: \"dateFilter\",\r\n        value: function() {\r\n            return this._filterRegistry.date\r\n        }\r\n    }]);\r\n    return FilterMaker\r\n}();\r\nvar compareDateWithStartDayHour = function(startDate, endDate, startDayHour, allDay, severalDays) {\r\n    var startTime = _date2.default.dateTimeFromDecimal(startDayHour);\r\n    var result = startDate.getHours() >= startTime.hours && startDate.getMinutes() >= startTime.minutes || endDate.getHours() === startTime.hours && endDate.getMinutes() > startTime.minutes || endDate.getHours() > startTime.hours || severalDays || allDay;\r\n    return result\r\n};\r\nvar compareDateWithEndDayHour = function(startDate, endDate, startDayHour, endDayHour, allDay, severalDays, max, min) {\r\n    var hiddenInterval = (24 - endDayHour + startDayHour) * toMs(\"hour\");\r\n    var apptDuration = endDate.getTime() - startDate.getTime();\r\n    var delta = (hiddenInterval - apptDuration) / toMs(\"hour\");\r\n    var apptStartHour = startDate.getHours();\r\n    var apptStartMinutes = startDate.getMinutes();\r\n    var result;\r\n    var endTime = _date2.default.dateTimeFromDecimal(endDayHour);\r\n    var startTime = _date2.default.dateTimeFromDecimal(startDayHour);\r\n    result = apptStartHour < endTime.hours || apptStartHour === endTime.hours && apptStartMinutes < endTime.minutes || allDay && startDate <= max || severalDays && startDate < max && endDate > min && (apptStartHour < endTime.hours || 60 * endDate.getHours() + endDate.getMinutes() > 60 * startTime.hours);\r\n    if (apptDuration < hiddenInterval) {\r\n        if (apptStartHour > endTime.hours && apptStartMinutes > endTime.minutes && delta <= apptStartHour - endDayHour) {\r\n            result = false\r\n        }\r\n    }\r\n    return result\r\n};\r\nvar AppointmentModel = function() {\r\n    function AppointmentModel(dataSource, dataAccessors, baseAppointmentDuration) {\r\n        _classCallCheck(this, AppointmentModel);\r\n        this.setDataAccessors(dataAccessors);\r\n        this.setDataSource(dataSource);\r\n        this._updatedAppointmentKeys = [];\r\n        this._filterMaker = new FilterMaker(dataAccessors);\r\n        this._baseAppointmentDuration = baseAppointmentDuration\r\n    }\r\n    _createClass(AppointmentModel, [{\r\n        key: \"_createFilter\",\r\n        value: function(min, max, remoteFiltering, dateSerializationFormat) {\r\n            this._filterMaker.make(\"date\", [min, max]);\r\n            var userFilterPosition = this._excessFiltering() ? this._dataSource.filter()[USER_FILTER_POSITION] : this._dataSource.filter();\r\n            this._filterMaker.make(\"user\", [userFilterPosition]);\r\n            if (remoteFiltering) {\r\n                this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat))\r\n            }\r\n        }\r\n    }, {\r\n        key: \"_excessFiltering\",\r\n        value: function() {\r\n            var dateFilter = this._filterMaker.dateFilter();\r\n            var dataSourceFilter = this._dataSource.filter();\r\n            return dataSourceFilter && ((0, _common.equalByValue)(dataSourceFilter, dateFilter) || dataSourceFilter.length && (0, _common.equalByValue)(dataSourceFilter[DATE_FILTER_POSITION], dateFilter))\r\n        }\r\n    }, {\r\n        key: \"_combineFilter\",\r\n        value: function() {\r\n            return this._filterMaker.combine()\r\n        }\r\n    }, {\r\n        key: \"_getStoreKey\",\r\n        value: function(target) {\r\n            var store = this._dataSource.store();\r\n            return store.keyOf(target)\r\n        }\r\n    }, {\r\n        key: \"_filterAppointmentByResources\",\r\n        value: function(appointment, resources) {\r\n            var _this2 = this;\r\n            var result = false;\r\n            var checkAppointmentResourceValues = function() {\r\n                var resourceGetter = _this2._dataAccessors.getter.resources[resourceName];\r\n                var resource;\r\n                if (_type2.default.isFunction(resourceGetter)) {\r\n                    resource = resourceGetter(appointment)\r\n                }\r\n                var appointmentResourceValues = _array2.default.wrapToArray(resource);\r\n                var resourceData = _iterator2.default.map(resources[i].items, function(item) {\r\n                    return item.id\r\n                });\r\n                for (var j = 0, itemDataCount = appointmentResourceValues.length; j < itemDataCount; j++) {\r\n                    if ((0, _array.inArray)(appointmentResourceValues[j], resourceData) > -1) {\r\n                        return true\r\n                    }\r\n                }\r\n                return false\r\n            };\r\n            for (var i = 0, len = resources.length; i < len; i++) {\r\n                var resourceName = resources[i].name;\r\n                result = checkAppointmentResourceValues.call(this);\r\n                if (!result) {\r\n                    return false\r\n                }\r\n            }\r\n            return result\r\n        }\r\n    }, {\r\n        key: \"_filterAppointmentByRRule\",\r\n        value: function(appointment, min, max, startDayHour, endDayHour, firstDayOfWeek) {\r\n            var recurrenceRule = appointment.recurrenceRule;\r\n            var recurrenceException = appointment.recurrenceException;\r\n            var allDay = appointment.allDay;\r\n            var result = true;\r\n            var appointmentStartDate = appointment.startDate;\r\n            var appointmentEndDate = appointment.endDate;\r\n            if (allDay || this._appointmentPartInInterval(appointmentStartDate, appointmentEndDate, startDayHour, endDayHour)) {\r\n                var trimmedDates = this._trimDates(min, max);\r\n                min = trimmedDates.min;\r\n                max = new Date(trimmedDates.max.getTime() - toMs(\"minute\"))\r\n            }\r\n            if (recurrenceRule && !_utils2.default.getRecurrenceRule(recurrenceRule).isValid) {\r\n                result = appointmentEndDate > min && appointmentStartDate <= max\r\n            }\r\n            if (result && _utils2.default.getRecurrenceRule(recurrenceRule).isValid) {\r\n                result = _utils2.default.dateInRecurrenceRange({\r\n                    rule: recurrenceRule,\r\n                    exception: recurrenceException,\r\n                    start: appointmentStartDate,\r\n                    end: appointmentEndDate,\r\n                    min: min,\r\n                    max: max,\r\n                    firstDayOfWeek: firstDayOfWeek\r\n                })\r\n            }\r\n            return result\r\n        }\r\n    }, {\r\n        key: \"_appointmentPartInInterval\",\r\n        value: function(startDate, endDate, startDayHour, endDayHour) {\r\n            var apptStartDayHour = startDate.getHours();\r\n            var apptEndDayHour = endDate.getHours();\r\n            return apptStartDayHour <= startDayHour && apptEndDayHour <= endDayHour && apptEndDayHour >= startDayHour || apptEndDayHour >= endDayHour && apptStartDayHour <= endDayHour && apptStartDayHour >= startDayHour\r\n        }\r\n    }, {\r\n        key: \"_createCombinedFilter\",\r\n        value: function(filterOptions, timeZoneProcessor) {\r\n            var dataAccessors = this._dataAccessors;\r\n            var startDayHour = filterOptions.startDayHour;\r\n            var endDayHour = filterOptions.endDayHour;\r\n            var min = new Date(filterOptions.min);\r\n            var max = new Date(filterOptions.max);\r\n            var resources = filterOptions.resources;\r\n            var firstDayOfWeek = filterOptions.firstDayOfWeek;\r\n            var getRecurrenceException = filterOptions.recurrenceException;\r\n            var that = this;\r\n            return [\r\n                [function(appointment) {\r\n                    var result = true;\r\n                    var startDate = new Date(dataAccessors.getter.startDate(appointment));\r\n                    var endDate = new Date(dataAccessors.getter.endDate(appointment));\r\n                    var appointmentTakesAllDay = that.appointmentTakesAllDay(appointment, startDayHour, endDayHour);\r\n                    var appointmentTakesSeveralDays = that.appointmentTakesSeveralDays(appointment);\r\n                    var isAllDay = dataAccessors.getter.allDay(appointment);\r\n                    var appointmentIsLong = appointmentTakesSeveralDays || appointmentTakesAllDay;\r\n                    var useRecurrence = _type2.default.isDefined(dataAccessors.getter.recurrenceRule);\r\n                    var recurrenceRule;\r\n                    if (useRecurrence) {\r\n                        recurrenceRule = dataAccessors.getter.recurrenceRule(appointment)\r\n                    }\r\n                    if (resources && resources.length) {\r\n                        result = that._filterAppointmentByResources(appointment, resources)\r\n                    }\r\n                    if (appointmentTakesAllDay && false === filterOptions.allDay) {\r\n                        result = false\r\n                    }\r\n                    var startDateTimeZone = dataAccessors.getter.startDateTimeZone(appointment);\r\n                    var endDateTimeZone = dataAccessors.getter.endDateTimeZone(appointment);\r\n                    var comparableStartDate = timeZoneProcessor(startDate, startDateTimeZone);\r\n                    var comparableEndDate = timeZoneProcessor(endDate, endDateTimeZone);\r\n                    if (result && useRecurrence) {\r\n                        var recurrenceException = getRecurrenceException ? getRecurrenceException(appointment) : dataAccessors.getter.recurrenceException(appointment);\r\n                        result = that._filterAppointmentByRRule({\r\n                            startDate: comparableStartDate,\r\n                            endDate: comparableEndDate,\r\n                            recurrenceRule: recurrenceRule,\r\n                            recurrenceException: recurrenceException,\r\n                            allDay: appointmentTakesAllDay\r\n                        }, min, max, startDayHour, endDayHour, firstDayOfWeek)\r\n                    }\r\n                    if (result && comparableEndDate < min && appointmentIsLong && !isAllDay && (!useRecurrence || useRecurrence && !recurrenceRule)) {\r\n                        result = false\r\n                    }\r\n                    if (result && void 0 !== startDayHour) {\r\n                        result = compareDateWithStartDayHour(comparableStartDate, comparableEndDate, startDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays)\r\n                    }\r\n                    if (result && void 0 !== endDayHour) {\r\n                        result = compareDateWithEndDayHour(comparableStartDate, comparableEndDate, startDayHour, endDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays, max, min)\r\n                    }\r\n                    if (result && useRecurrence && !recurrenceRule) {\r\n                        if (comparableEndDate < min && !isAllDay) {\r\n                            result = false\r\n                        }\r\n                    }\r\n                    return result\r\n                }]\r\n            ]\r\n        }\r\n    }, {\r\n        key: \"setDataSource\",\r\n        value: function(dataSource) {\r\n            this._dataSource = dataSource;\r\n            this.cleanModelState();\r\n            this._initStoreChangeHandlers();\r\n            this._filterMaker && this._filterMaker.clearRegistry()\r\n        }\r\n    }, {\r\n        key: \"_initStoreChangeHandlers\",\r\n        value: function() {\r\n            var _this3 = this;\r\n            this._dataSource && this._dataSource.store().on(\"updating\", function(newItem) {\r\n                _this3._updatedAppointment = newItem\r\n            }.bind(this));\r\n            this._dataSource && this._dataSource.store().on(\"push\", function(items) {\r\n                items.forEach(function(item) {\r\n                    _this3._updatedAppointmentKeys.push({\r\n                        key: _this3._dataSource.store().key(),\r\n                        value: item.key\r\n                    })\r\n                }.bind(_this3))\r\n            }.bind(this))\r\n        }\r\n    }, {\r\n        key: \"getUpdatedAppointment\",\r\n        value: function() {\r\n            return this._updatedAppointment\r\n        }\r\n    }, {\r\n        key: \"getUpdatedAppointmentKeys\",\r\n        value: function() {\r\n            return this._updatedAppointmentKeys\r\n        }\r\n    }, {\r\n        key: \"cleanModelState\",\r\n        value: function() {\r\n            this._updatedAppointment = null;\r\n            this._updatedAppointmentKeys = []\r\n        }\r\n    }, {\r\n        key: \"setDataAccessors\",\r\n        value: function(dataAccessors) {\r\n            this._dataAccessors = dataAccessors;\r\n            this._filterMaker = new FilterMaker(dataAccessors)\r\n        }\r\n    }, {\r\n        key: \"filterByDate\",\r\n        value: function(min, max, remoteFiltering, dateSerializationFormat) {\r\n            if (!this._dataSource) {\r\n                return\r\n            }\r\n            var trimmedDates = this._trimDates(min, max);\r\n            if (!this._filterMaker.isRegistered()) {\r\n                this._createFilter(trimmedDates.min, trimmedDates.max, remoteFiltering, dateSerializationFormat)\r\n            } else {\r\n                this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max]);\r\n                if (this._dataSource.filter() && this._dataSource.filter().length > 1) {\r\n                    var userFilter = this._serializeRemoteFilter([this._dataSource.filter()[1]], dateSerializationFormat);\r\n                    this._filterMaker.make(\"user\", userFilter)\r\n                }\r\n                if (remoteFiltering) {\r\n                    this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat))\r\n                }\r\n            }\r\n        }\r\n    }, {\r\n        key: \"_combineRemoteFilter\",\r\n        value: function(dateSerializationFormat) {\r\n            var combinedFilter = this._filterMaker.combine();\r\n            return this._serializeRemoteFilter(combinedFilter, dateSerializationFormat)\r\n        }\r\n    }, {\r\n        key: \"_serializeRemoteFilter\",\r\n        value: function(filter, dateSerializationFormat) {\r\n            if (!Array.isArray(filter)) {\r\n                return filter\r\n            }\r\n            filter = (0, _extend.extend)([], filter);\r\n            var startDate = this._dataAccessors.expr.startDateExpr;\r\n            var endDate = this._dataAccessors.expr.endDateExpr;\r\n            if (_type2.default.isString(filter[0])) {\r\n                if ((0, _config2.default)().forceIsoDateParsing && filter.length > 1) {\r\n                    if (filter[0] === startDate || filter[0] === endDate) {\r\n                        filter[filter.length - 1] = _date_serialization2.default.serializeDate(new Date(filter[filter.length - 1]), dateSerializationFormat)\r\n                    }\r\n                }\r\n            }\r\n            for (var i = 0; i < filter.length; i++) {\r\n                filter[i] = this._serializeRemoteFilter(filter[i], dateSerializationFormat)\r\n            }\r\n            return filter\r\n        }\r\n    }, {\r\n        key: \"filterLoadedAppointments\",\r\n        value: function(filterOptions, timeZoneProcessor) {\r\n            if (!_type2.default.isFunction(timeZoneProcessor)) {\r\n                timeZoneProcessor = function(date) {\r\n                    return date\r\n                }\r\n            }\r\n            var combinedFilter = this._createCombinedFilter(filterOptions, timeZoneProcessor);\r\n            if (this._filterMaker.isRegistered()) {\r\n                var trimmedDates = this._trimDates(filterOptions.min, filterOptions.max);\r\n                this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max, true]);\r\n                var dateFilter = this.customizeDateFilter(this._filterMaker.combine(), timeZoneProcessor);\r\n                combinedFilter.push([dateFilter])\r\n            }\r\n            return (0, _query2.default)(this._dataSource.items()).filter(combinedFilter).toArray()\r\n        }\r\n    }, {\r\n        key: \"_trimDates\",\r\n        value: function(min, max) {\r\n            var minCopy = _date2.default.trimTime(new Date(min));\r\n            var maxCopy = _date2.default.trimTime(new Date(max));\r\n            maxCopy.setDate(maxCopy.getDate() + 1);\r\n            return {\r\n                min: minCopy,\r\n                max: maxCopy\r\n            }\r\n        }\r\n    }, {\r\n        key: \"hasAllDayAppointments\",\r\n        value: function(items, startDayHour, endDayHour) {\r\n            if (!items) {\r\n                return false\r\n            }\r\n            var that = this;\r\n            var result = false;\r\n            _iterator2.default.each(items, function(index, item) {\r\n                if (that.appointmentTakesAllDay(item, startDayHour, endDayHour)) {\r\n                    result = true;\r\n                    return false\r\n                }\r\n            });\r\n            return result\r\n        }\r\n    }, {\r\n        key: \"appointmentTakesAllDay\",\r\n        value: function(appointment, startDayHour, endDayHour) {\r\n            var dataAccessors = this._dataAccessors;\r\n            var startDate = dataAccessors.getter.startDate(appointment);\r\n            var endDate = dataAccessors.getter.endDate(appointment);\r\n            var allDay = dataAccessors.getter.allDay(appointment);\r\n            return allDay || this._appointmentHasAllDayDuration(startDate, endDate, startDayHour, endDayHour)\r\n        }\r\n    }, {\r\n        key: \"_appointmentHasAllDayDuration\",\r\n        value: function(startDate, endDate, startDayHour, endDayHour) {\r\n            startDate = new Date(startDate);\r\n            endDate = new Date(endDate);\r\n            var dayDuration = 24;\r\n            var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\r\n            return appointmentDurationInHours >= dayDuration || this._appointmentHasShortDayDuration(startDate, endDate, startDayHour, endDayHour)\r\n        }\r\n    }, {\r\n        key: \"_appointmentHasShortDayDuration\",\r\n        value: function(startDate, endDate, startDayHour, endDayHour) {\r\n            var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\r\n            var shortDayDurationInHours = endDayHour - startDayHour;\r\n            return appointmentDurationInHours >= shortDayDurationInHours && startDate.getHours() === startDayHour && endDate.getHours() === endDayHour\r\n        }\r\n    }, {\r\n        key: \"_getAppointmentDurationInHours\",\r\n        value: function(startDate, endDate) {\r\n            return (endDate.getTime() - startDate.getTime()) / toMs(\"hour\")\r\n        }\r\n    }, {\r\n        key: \"appointmentTakesSeveralDays\",\r\n        value: function(appointment) {\r\n            var dataAccessors = this._dataAccessors;\r\n            var startDate = dataAccessors.getter.startDate(appointment);\r\n            var endDate = dataAccessors.getter.endDate(appointment);\r\n            var startDateCopy = _date2.default.trimTime(new Date(startDate));\r\n            var endDateCopy = _date2.default.trimTime(new Date(endDate));\r\n            return startDateCopy.getTime() !== endDateCopy.getTime()\r\n        }\r\n    }, {\r\n        key: \"customizeDateFilter\",\r\n        value: function(dateFilter, timeZoneProcessor) {\r\n            var _this4 = this;\r\n            var currentFilter = (0, _extend.extend)(true, [], dateFilter);\r\n            return function(appointment) {\r\n                var startDate = new Date(_this4._dataAccessors.getter.startDate(appointment));\r\n                var endDate = new Date(_this4._dataAccessors.getter.endDate(appointment));\r\n                endDate = _this4.fixWrongEndDate(appointment, startDate, endDate);\r\n                appointment = (0, _extend.extend)(true, {}, appointment);\r\n                var startDateTimeZone = _this4._dataAccessors.getter.startDateTimeZone(appointment);\r\n                var endDateTimeZone = _this4._dataAccessors.getter.endDateTimeZone(appointment);\r\n                var comparableStartDate = timeZoneProcessor(startDate, startDateTimeZone);\r\n                var comparableEndDate = timeZoneProcessor(endDate, endDateTimeZone);\r\n                _this4._dataAccessors.setter.startDate(appointment, comparableStartDate);\r\n                _this4._dataAccessors.setter.endDate(appointment, comparableEndDate);\r\n                return (0, _query2.default)([appointment]).filter(currentFilter).toArray().length > 0\r\n            }.bind(this)\r\n        }\r\n    }, {\r\n        key: \"fixWrongEndDate\",\r\n        value: function(appointment, startDate, endDate) {\r\n            if (this._isEndDateWrong(appointment, startDate, endDate)) {\r\n                if (this._dataAccessors.getter.allDay(appointment)) {\r\n                    endDate = _date2.default.setToDayEnd(new Date(startDate))\r\n                } else {\r\n                    endDate = new Date(startDate.getTime() + this._baseAppointmentDuration * toMs(\"minute\"))\r\n                }\r\n                this._dataAccessors.setter.endDate(appointment, endDate)\r\n            }\r\n            return endDate\r\n        }\r\n    }, {\r\n        key: \"_isEndDateWrong\",\r\n        value: function(appointment, startDate, endDate) {\r\n            return !endDate || isNaN(endDate.getTime()) || startDate.getTime() > endDate.getTime()\r\n        }\r\n    }, {\r\n        key: \"add\",\r\n        value: function(data, tz) {\r\n            var _this5 = this;\r\n            return this._dataSource.store().insert(data).done(function() {\r\n                _this5._dataSource.load()\r\n            }.bind(this))\r\n        }\r\n    }, {\r\n        key: \"update\",\r\n        value: function(target, data) {\r\n            var _this6 = this;\r\n            var key = this._getStoreKey(target);\r\n            var d = new _deferred.Deferred;\r\n            this._dataSource.store().update(key, data).done(function() {\r\n                _this6._dataSource.load().done(d.resolve).fail(d.reject)\r\n            }).fail(d.reject);\r\n            return d.promise()\r\n        }\r\n    }, {\r\n        key: \"remove\",\r\n        value: function(target) {\r\n            var _this7 = this;\r\n            var key = this._getStoreKey(target);\r\n            return this._dataSource.store().remove(key).done(function() {\r\n                _this7._dataSource.load()\r\n            }.bind(this))\r\n        }\r\n    }]);\r\n    return AppointmentModel\r\n}();\r\nmodule.exports = AppointmentModel;\r\n"]},"metadata":{},"sourceType":"script"}